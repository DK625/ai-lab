**Phase 4: Decomposition** là giai đoạn "chia nhỏ" bài toán lớn thành các đơn vị công việc cực nhỏ và độc lập, được gọi là **Beads** (thường là các file `.md` trong thư mục `.beads/`).

Mục tiêu của giai đoạn này là biến các ý tưởng và kết quả nghiên cứu từ các Phase trước thành một "bản hướng dẫn lắp ráp" chi tiết đến mức một AI agent khác (Worker) có thể cầm lên và thực hiện ngay mà không cần hỏi lại.

Dưới đây là giải thích chi tiết các yêu cầu trong Phase này:

### 1. Ý nghĩa các thành phần trong yêu cầu

* **skill("file-beads")**: Đây là lệnh kích hoạt công cụ chuyên dụng để tạo và quản lý các file bead. Nó giúp đảm bảo các task được định dạng đúng chuẩn và lưu trữ đúng cấu trúc thư mục.
* **Spike learnings embedded**: Nếu ở Phase 3 bạn đã làm Spike (nghiên cứu) và rút ra được bài học (ví dụ: "Phải dùng hàm A thay vì hàm B để tránh lỗi bộ nhớ"), bạn **bắt buộc** phải chép bài học đó vào phần mô tả của Bead. Điều này ngăn chặn việc người thực hiện sau đó phải đi nghiên cứu lại từ đầu.
* **Reference to .spikes/ code**: Đối với những phần rủi ro cao (HIGH risk), bạn phải chỉ rõ đường dẫn đến code mẫu bạn đã viết trong giai đoạn Spike để người thực hiện có thể copy hoặc tham khảo.
* **Clear acceptance criteria (AC)**: Tiêu chí nghiệm thu. Đây là danh sách các điều kiện để xác định Task đó đã hoàn thành hay chưa (ví dụ: "API phải trả về code 200", "Dữ liệu phải được lưu vào DB").
* **File scope**: Đây là phần cực kỳ quan trọng. Bạn phải liệt kê các file hoặc thư mục mà Task này sẽ tác động đến. Việc này giúp hệ thống ở Phase 6 có thể phân chia công việc cho nhiều Agent chạy song song mà không bị sửa đè file của nhau.

---

### 2. Ví dụ minh họa cụ thể

Tiếp tục với ví dụ **"Tích hợp thanh toán Stripe"** sau khi đã làm Spike xong.

#### Lệnh khởi tạo:

`bd create "Implement Stripe Webhook Handler" -t task`

#### Nội dung của Bead (sau khi dùng skill file-beads để cập nhật):

> **Description**:
> Thiết lập endpoint để nhận thông báo thanh toán từ Stripe.
> **> Spike Learnings:** Qua thực nghiệm tại `.spikes/stripe-auth/`, chúng ta biết rằng Stripe yêu cầu `raw body` để xác thực chữ ký (signature). Không được dùng `body-parser` dạng JSON thông thường vì sẽ làm sai lệch hash.
> **Acceptance Criteria**:
> * [ ] Tạo thành công POST endpoint `/api/webhooks/stripe`.
> * [ ] Xác thực được `stripe-signature` từ header.
> * [ ] Cập nhật trạng thái đơn hàng trong Database thành `paid`.
> * [ ] Trả về `200 OK` cho Stripe trong vòng < 2 giây.
> 
> 
> **File Scope**:
> * `apps/server/src/routes/webhook.ts`
> * `apps/server/src/services/order.service.ts`
> 
> 

---

### 3. Tại sao Phase này lại quan trọng?

* **Tính đóng gói (Encapsulation)**: Mỗi Bead là một gói kiến thức hoàn chỉnh. Worker không cần đọc toàn bộ tài liệu dự án, chỉ cần đọc đúng file Bead là đủ.
* **Hỗ trợ chạy song song (Parallelism)**: Nhờ có **File scope**, hệ thống biết được Task A sửa file X, Task B sửa file Y. Do đó, nó có thể cử hai Agent làm việc cùng một lúc mà không sợ xung đột (conflict).
* **Kiểm soát chất lượng**: Với **Acceptance criteria** rõ ràng, việc kiểm tra (Review) kết quả sau này sẽ cực kỳ nhanh chóng và khách quan.
