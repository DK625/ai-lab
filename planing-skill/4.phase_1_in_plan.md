Task() → Agent A: Architecture snapshot (gkg repo_map)
Task() → Agent B: Pattern search (find similar existing code) => đoạn này có thể sử dụng serena
Task() → Agent C: Constraints (package.json, tsconfig, deps)
Librarian → External patterns ("how do similar projects do this?")
exa → Library docs (if external integration needed)

Đoạn flow bạn vừa trích xuất chính là mô tả chi tiết cho **Phase 1: Discovery (Khám phá)** trong tài liệu `planning.md` của bạn.

Thay vì để một AI duy nhất tự "bơi" trong đống code, flow này sử dụng chiến thuật **"Chia để trị" (Divide and Conquer)** bằng cách huy động một nhóm các Agent phụ (Sub-agents) và công cụ chuyên biệt để thu thập thông tin đa chiều cùng một lúc.

Dưới đây là giải thích chi tiết ý nghĩa của từng tác vụ trong flow này:

### 1. Nhóm Agent nội bộ (Internal Discovery)

Nhóm này tập trung hoàn toàn vào việc hiểu những gì đang có sẵn trong Repository của bạn để đảm bảo tính nhất quán.

* **Agent A - Architecture snapshot (`gkg repo_map`):** Agent này đóng vai trò "người vẽ bản đồ". Nó sử dụng công cụ `repo_map` để quét toàn bộ cấu trúc thư mục, giúp AI biết được feature mới nên nằm ở đâu và nó sẽ tác động đến những module nào đang tồn tại.
* **Agent B - Pattern search:** Agent này là "người tìm kiếm sự tương đồng". Nó lục tìm trong codebase xem đã có tính năng nào tương tự chưa (ví dụ: một logic xử lý API cũ). Mục tiêu là để code mới viết ra sẽ có phong cách (style) và logic đồng nhất với code cũ.
* **Agent C - Constraints:** Agent này là "người kiểm soát luật lệ". Nó kiểm tra các file cấu hình như `package.json` (để biết có những thư viện nào dùng được), `tsconfig` (để biết quy tắc viết code), nhằm đảm bảo kế hoạch đề ra không bị lỗi kỹ thuật ngay từ đầu.

---

### 2. Nhóm công cụ bên ngoài (External Intelligence)

Nhóm này giúp AI mở rộng tầm nhìn ra ngoài phạm vi máy tính của bạn để tìm kiếm giải pháp tối ưu nhất.

* **Librarian (External patterns):** Đóng vai trò là "chuyên gia tra cứu". Nếu bạn định làm một thứ hoàn toàn mới mà trong code chưa có, Librarian sẽ đi tìm trong các bộ tài liệu (docs) đã lưu trữ để xem "thiên hạ thường làm việc này như thế nào" (Best practices).
* **Exa (Library docs):** Đóng vai trò là "trinh sát thực địa". Khi Librarian không có sẵn dữ liệu, Exa sẽ lên mạng để lấy những tài liệu API mới nhất hoặc các bản cập nhật vừa ra mắt để AI không dùng phải những kiến thức đã lỗi thời.

---

### Kết quả cuối cùng: Discovery Report

Mục tiêu của toàn bộ flow này là để tạo ra một **Discovery Report (Báo cáo khám phá)** lưu tại `history//discovery.md`. Bản báo cáo này là nền tảng để bước sang **Phase 2: Synthesis**, nơi AI sẽ đánh giá xem:

* Cái gì đã có sẵn?
* Cái gì còn thiếu?
* Mức độ rủi ro (LOW/MEDIUM/HIGH) của tính năng này là bao nhiêu?

> **Tóm lại:** Flow này giúp bạn tránh được sai lầm lớn nhất khi lập trình: **"Nhào vô code ngay khi chưa hiểu rõ hệ thống"**. Nó biến quá trình lập kế hoạch từ việc "đoán mò" thành một quy trình dựa trên dữ liệu thực tế.